---
import { getImage } from "astro:assets";

let {
  src,
  aspect,
  attributes,
  sizes = "100vw",
  alt = "my image",
  width = 640,
  height = 640,
  loading = "lazy",
  widths = [
    240, 320, 400, 450, 480, 580, 640, 750, 828, 940, 990, 1080, 1200, 1450, 1920,
  ],
  artDirectives = [],
  layout = "fill",
} = Astro.props;

// Import tất cả ảnh từ assets (bao gồm webp)
const allImages = import.meta.glob("/src/assets/*.{jpeg,jpg,png,gif,webp}");

// Nếu chỉ truyền tên file → build path đầy đủ
let imgPath = src?.startsWith("/src/assets/")
    ? src
    : `/src/assets/${src}`;

// Nếu ảnh không tồn tại trong glob → fallback ảnh mặc định
if (!allImages[imgPath]) {
  console.warn(`Image not found: ${src}, using fallback image.`);
  imgPath = "/src/assets/fallback.webp"; // bạn tạo 1 ảnh fallback trong src/assets
}

const imgImport = await allImages[imgPath]();
const imgObj = imgImport?.default;

// Nếu có aspect → tự tính height
if (aspect) height = Math.round(width / aspect);

// Tạo ảnh tối ưu bằng astro:assets
const image = await getImage({
  src: imgObj,
  width,
  height,
  aspect,
  format: imgObj.format,
});
---

<picture>
  <img
      src={image.src}
      srcset={image.srcSet.attribute}
      sizes={sizes}
      alt={alt}
      loading={loading}
      {...attributes}
  />
</picture>
